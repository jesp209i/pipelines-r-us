name: (pwsh) ðŸš€ Umbraco Cloud Deployment pipeline

on:
  push:
    branches:
     - main
  workflow_dispatch:
    inputs:
      perform_cloud_sync:
        description: 'Run Sync operation First'
        type: boolean
        default: true

jobs:
  cloud-sync:
    name: "Syncronize with Cloud"
    uses: ./.github/workflows/pwsh-cloud-sync.yml
    if: ${{ GITHUB.EVENT_NAME == 'push' || ( GITHUB.EVENT_NAME == 'workflow_dispatch' && inputs.perform_cloud_sync == true) }}
    secrets:
      projectId: ${{ secrets.PROJECT_ID }}
      umbracoCloudApiKey: ${{ secrets.UMBRACO_CLOUD_API_KEY }}

  # this job is here to prevent deployment to start before the optional cloud-sync job has been done
  conditional-flow:
    name: Determining manual run flow
    runs-on: ubuntu-latest
    needs: cloud-sync
    if: ${{ success() || inputs.perform_sync == false}}
    steps:
      - run: echo "Ready to run deployment"      

  # Package and Deploy to Umbraco Cloud
  cloud-deployment:
    name: "Deploy to Cloud"
    uses: ./.github/workflows/pwsh-cloud-deployment.yml
    needs: conditional-flow
    if: always()
    secrets:
      projectId: ${{ secrets.PROJECT_ID }}
      umbracoCloudApiKey: ${{ secrets.UMBRACO_CLOUD_API_KEY }}